<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Brasil Store - O Seu Portal Gaming</title>
    <!-- Carrega Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Personalizados - Tema Cyber Gaming (Dark Mode com Neon Blue) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0A0A0A; /* Fundo Ultra Dark */
            color: #E5E7EB; /* Texto claro */
        }
        
        /* Estilo para Cards de Produto */
        .product-card { 
            background-color: #1F2937; /* Base escura */
            border: 1px solid #374151;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .product-card:hover { 
            transform: translateY(-8px); 
            /* Sombra Neon Blue */
            box-shadow: 0 20px 25px -5px rgba(6, 182, 212, 0.4), 0 8px 10px -6px rgba(6, 182, 212, 0.3); 
        }
        
        /* Estilo da barra lateral (Carrinho) */
        .bg-aside {
            background-color: #111827; /* Fundo mais escuro para destaque */
            border: 2px solid #06B6D4; /* Borda Neon */
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); /* Brilho Neon */
        }

        /* Estilo Primário (Botão e Destaque) */
        .btn-primary { 
            background-color: #06B6D4; /* Cyan/Blue Neon */
            color: #111827;
            font-weight: 700;
        }
        .btn-primary:hover { 
            background-color: #0891B2;
            box-shadow: 0 0 10px #06B6D4;
        }
        
        /* Inputs */
        .input-focus:focus { /* Adicionado seletor :focus para classes customizadas */
            outline: none; 
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.5);
            background-color: #374151; 
            border-color: #06B6D4;
            color: #E5E7EB;
        }
        
        /* Animação para o Total */
        .total-glow {
            text-shadow: 0 0 8px #06B6D4;
        }

        /* Responsividade para o Grid de Produtos */
        @media (min-width: 1024px) {
            .products-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        @media (min-width: 640px) and (max-width: 1023px) {
            .products-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Cabeçalho (UI/UX) -->
    <header class="bg-gray-900 text-white shadow-xl sticky top-0 z-20 border-b border-cyan-600">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-cyan-400 tracking-widest total-glow">
                ARCADE BRASIL STORE
            </h1>
            <div class="flex items-center space-x-6">
                <!-- O userId é crucial para multi-usuário, mantido visível. -->
               <span id="user-id-display" class="text-sm bg-gray-700 py-1 px-3 rounded-full text-gray-300 hidden sm:block shadow-inner">ID: Carregando...</span>
                <!-- Ícone e Contador do Carrinho (UI/UX) -->
                <div id="cart-icon" class="relative cursor-pointer p-2 rounded-full hover:bg-gray-700 transition">
                    <!-- Ícone de Saco de Compras -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-cyan-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full ring-2 ring-gray-900">0</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Coluna Principal: Produtos e Filtros (Ocupa 3/4 no Desktop) -->
        <section class="lg:col-span-3">
            <h2 class="text-4xl font-extrabold text-cyan-400 mb-6 border-b-4 border-cyan-800 pb-3">
                Catálogo de Equipamentos e Jogos
            </h2>

            <!-- Barra de Pesquisa e Filtros (UI/UX) -->
            <div class="flex flex-col sm:flex-row gap-4 mb-10 p-4 bg-gray-800 rounded-xl shadow-2xl">
                <input type="text" id="search-input" placeholder="Pesquisar jogos, acessórios ou hardware..." 
                        class="flex-1 p-3 border border-gray-600 rounded-lg focus:input-focus transition duration-150">
                
                <select id="category-filter" 
                        class="p-3 border border-gray-600 rounded-lg bg-gray-700 text-white focus:input-focus transition duration-150 sm:w-1/3">
                    <option value="all">Todas as Categorias</option>
                    <!-- Opções de categoria serão preenchidas via JS -->
                </select>
            </div>

            <div id="products-grid" class="products-grid grid grid-cols-1 gap-6">
                <!-- Cards de produtos serão injetados aqui -->
            </div>
        </section>

        <!-- Coluna Lateral: Carrinho e Checkout (Sempre visível no topo da página no mobile) -->
        <aside class="lg:col-span-1 bg-aside p-6 rounded-2xl h-fit sticky top-24 transform transition duration-500">
            <h2 class="text-3xl font-bold text-cyan-400 mb-6">Seu Carrinho</h2>
            
            <!-- Mensagem de carrinho vazio -->
            <p class="text-gray-400 italic mb-4 p-2 border-l-4 border-red-500" id="empty-cart-message">
                Navegue pelo catálogo e adicione itens para começar!
            </p>
            
            <!-- Lista de Itens do Carrinho -->
            <div id="cart-items" class="space-y-4 mb-6 border-b border-gray-700 pb-4">
                <!-- Itens do carrinho serão injetados aqui -->
            </div>
            
            <!-- Resumo do Carrinho -->
            <div class="space-y-4 pt-2">
                <div class="flex justify-between font-semibold text-lg text-gray-300">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal" class="font-extrabold text-yellow-400">R$ 0,00</span>
                </div>
                <div class="flex justify-between font-semibold text-lg text-gray-300">
                    <span>Frete:</span>
                    <span id="cart-shipping" class="font-extrabold text-yellow-400">R$ 0,00</span>
                </div>
                <div class="flex justify-between font-extrabold text-3xl text-cyan-400 pt-4 border-t border-dashed border-gray-700 total-glow">
                    <span>TOTAL:</span>
                    <span id="cart-total" class="total-glow">R$ 0,00</span>
                </div>
            </div>

            <!-- Botões de Ação -->
            <button id="checkout-btn" 
                    class="btn-primary text-black font-extrabold w-full py-3 mt-8 rounded-lg shadow-lg shadow-cyan-900/50 hover:shadow-cyan-400/50 transition duration-300 disabled:opacity-30 disabled:shadow-none"
                    disabled>
                FINALIZAR PEDIDO
            </button>
            <button id="save-cart-btn" 
                    class="w-full py-2 mt-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-300 disabled:opacity-30"
                    disabled>
                Salvar Carrinho para Depois
            </button>
        </aside>

    </main>

    <!-- Rodapé Educacional (Assinatura e Informações) -->
    <footer class="mt-16 p-6 text-center text-gray-400 text-sm bg-gray-900 border-t border-gray-700">
        <p class="max-w-7xl mx-auto">
            Este é um Simulador Educacional ("Arcade Brasil Store") feito para fins demonstrativos.
            <br>
            Demonstração de: POO, Front-End Responsivo e Persistência de Dados (Firestore).
            <br>
            <span class="mt-2 block text-cyan-500 font-bold">Desenvolvido por: Willian, Isaias, Pietro e Emanuel.</span>
        </p>
    </footer>

    <!-- Área para mensagens customizadas (substitui alert()) -->
    <div id="message-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Script JavaScript com a Lógica (POO, Estruturada e Persistência) -->
    <script type="module">
        // Importações do Firebase (Usando SDK 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis Globais de Firebase e Constantes
        let db;
        let auth;
        let userId = 'loading'; // ID do usuário ou anônimo
        let isAuthReady = false; // Flag para garantir que a autenticação terminou
        const SHIPPING_COST = 25.00; // Custo de envio em Reais
        const CART_DOC_PATH = "user_data/cart_state"; // Caminho dentro do espaço do usuário
        const REAL_SYMBOL = 'R$'; // Símbolo Real

        // Adiciona a referência ao appId global
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Configuração de Preços e Dados (Gaming - Em Reais)
        // ERROS CORRIGIDOS: Virgula adicionada em 103, 'imageh' corrigido para 'image' em 104, nome adicionado em 101.
        const initialProducts = [
          { id: 101, name: "", category: "Consoles", price: 4999.99, 
              image: "https://static.sbt.com.br/noticias/images/278811.jpg", 
              description: "Potência de próxima geração, Ray Tracing em tempo real e SSD NVMe ultrarrápido. O futuro do gaming." },
            
            { id: 102, name: "Cyberpunk 2077 (Ultimate Edition)", category: "Jogos", price: 299.90, 
              image: "https://store.playstation.com/store/api/chihiro/00_09_000/container/BR/en/99/UP4497-PPSA03974_00-EXPANSION1B00000/0/image?_version=00_09_000&platform=chihiro&bg_color=000000&opacity=100&w=720&h=720", 
              description: "Aventure-se na distópica Night City. Inclui todas as expansões e conteúdos digitais." },
            
            { id: 103, name: "Headset Pro Gamer 7.1 RGB", category: "Acessórios", price: 749.50, 
              image: "https://patoloco.com.br/resize/imagecache/f8ab4d7fdc51509f7723d33d12e12022.jpeg"
              ,description: "Áudio espacial, microfone com cancelamento de ruído e iluminação RGB personalizável." },

            { id: 104, name: "Placa de Vídeo RTX 5080 Extreme", category: "Hardware PC", price: 8999.00, 
              image: "https://images1.kabum.com.br/produtos/fotos/714561/placa-de-video-rtx-5080-aorus-xtreme-waterforce-16g-gigabyte-nvidia-geforce-16gb-gddr7-rgb-dlss-ray-tracing-9vn5080aw-00-g10_1740417347_gg.jpg", 
              description: "Desempenho máximo para 4K e 8K. Overclock de fábrica e refrigeração líquida integrada." },
            
            { id: 105, name: "Mousepad XXL Speed Control", category: "Acessórios", price: 129.90, 
              image: "https://patoloco.com.br/arquivos/produtos/imagens_adicionais/d002152d47a467d5a8bad25f89088747697afa0b.jpeg", 
              description: "Superfície otimizada para velocidade e precisão. Base de borracha antiderrapante." },
              
            { id: 106, name: "Monitor Curvo 144Hz 2ms 32''", category: "Monitores", price: 2450.00, 
              image: "https://images0.kabum.com.br/produtos/fotos/99000/monitor-gamer-gamemax-led-32-widescreen-curvo-qhd-hdmi-dvi-display-port-freesync-som-integrado-144hz-1ms-gmx32cewq__1541099306_g.jpg", 
              description: "Taxa de atualização alta e baixa latência para uma experiência visual fluida e imersiva." },
        ];
        
        // POO - Classe Produto
        class Product {
            constructor(id, name, category, price, image, description) {
                this.id = id;
                this.name = name;
                this.category = category;
                this.price = price;
                this.image = image;
                this.description = description;
            }
            
            get formattedPrice() {
                // Formatação Brasileira (vírgula como separador decimal, Real)
                return `${REAL_SYMBOL} ${this.price.toFixed(2).replace('.', ',')}`;
            }
        }

        // POO - Classe ShoppingCart (Carrinho de Compras)
        class ShoppingCart {
            constructor() {
                this.items = new Map(); // chave: id do produto, valor: {produto, quantidade}
            }

            addItem(product, quantity = 1) {
                const productId = product.id;
                if (this.items.has(productId)) {
                    this.items.get(productId).quantity += quantity;
                } else {
                    this.items.set(productId, { product, quantity });
                }
                this.updateUI();
                this.saveCart(false); // Simula o salvamento automático ao adicionar
            }
            
            changeQuantity(productId, newQuantity) {
                const item = this.items.get(productId);
                if (item) {
                    const quantity = parseInt(newQuantity);
                    if (quantity <= 0 || isNaN(quantity)) {
                        this.removeItem(productId);
                    } else {
                        item.quantity = quantity;
                        this.updateUI();
                        this.saveCart(false);
                    }
                }
            }

            removeItem(productId) {
                if (this.items.has(productId)) {
                    this.items.delete(productId);
                    this.updateUI();
                    this.saveCart(false);
                }
            }

            getSubtotal() {
                let subtotal = 0;
                for (const item of this.items.values()) {
                    subtotal += item.product.price * item.quantity;
                }
                return subtotal;
            }

            getTotal() {
                return this.getSubtotal() + (this.getSubtotal() > 0 ? SHIPPING_COST : 0);
            }

            // Simulação de Back-End: Salva o estado do carrinho no Firestore
            async saveCart(showNotification = true) {
                if (!isAuthReady) {
                    if (showNotification) displayMessage("Autenticação não concluída. Impossível salvar no momento.", 'alert');
                    return;
                }

                // Verifica se o usuário é anônimo para impedir o salvamento (Se preferir salvar, remova essa verificação)
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                     if (showNotification) displayMessage("Função 'Salvar Carrinho' requer um login persistente (não anônimo).", 'alert');
                    return;
                }

                try {
                    // Mapeia para um array serializável para salvar no Firestore (apenas ID e Quantidade)
                    const serializableItems = Array.from(this.items.values()).map(item => ({
                        productId: item.product.id,
                        quantity: item.quantity
                    }));

                    // Caminho para o documento privado do carrinho: artifacts/{appId}/users/{userId}/user_data/cart_state
                    const cartRef = doc(db, `artifacts/${appId}/users/${userId}/${CART_DOC_PATH}`);
                    await setDoc(cartRef, { items: serializableItems, timestamp: new Date().toISOString() });
                    if (showNotification) displayMessage("Carrinho salvo na nuvem com sucesso!", 'success');
                } catch (error) {
                    console.error("Erro ao salvar o carrinho:", error);
                    if (showNotification) displayMessage("Falha ao salvar o carrinho. Verifique a consola.", 'alert');
                }
            }

            // Simulação de Back-End: Carrega o estado do carrinho do Firestore
            async loadCart() {
                if (!isAuthReady || auth.currentUser.isAnonymous) return;

                try {
                    const cartRef = doc(db, `artifacts/${appId}/users/${userId}/${CART_DOC_PATH}`);
                    const docSnap = await getDoc(cartRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.items.clear();
                        data.items.forEach(item => {
                            // Busca o objeto Produto completo na lista inicial
                            const product = productInstances.find(p => p.id === item.productId);
                            if (product) {
                                this.items.set(product.id, { product, quantity: item.quantity });
                            }
                        });
                        displayMessage("Dados do carrinho carregados da nuvem.", 'info');
                        this.updateUI();
                    } else {
                        console.log("Nenhum carrinho salvo encontrado para este usuário.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar o carrinho:", error);
                    displayMessage("Erro ao carregar dados do carrinho. Dados antigos perdidos.", 'alert');
                }
            }

            updateUI() {
                const subtotal = this.getSubtotal();
                const total = this.getTotal();
                const itemCount = Array.from(this.items.values()).reduce((sum, item) => sum + item.quantity, 0);

                document.getElementById('cart-count').textContent = itemCount;
                document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('cart-shipping').textContent = subtotal > 0 ? formatCurrency(SHIPPING_COST) : formatCurrency(0);
                document.getElementById('cart-total').textContent = formatCurrency(total);
                
                const checkoutBtn = document.getElementById('checkout-btn');
                const saveBtn = document.getElementById('save-cart-btn');
                const emptyMessage = document.getElementById('empty-cart-message');
                
                // Habilita/Desabilita botões
                checkoutBtn.disabled = subtotal === 0;
                // O botão 'Salvar' só é habilitado se a autenticação estiver pronta E não for anônima.
                saveBtn.disabled = !isAuthReady || subtotal === 0 || (auth && auth.currentUser && auth.currentUser.isAnonymous);
                emptyMessage.style.display = subtotal === 0 ? 'block' : 'none';

                this.renderCartItems();
            }
            
            renderCartItems() {
                const container = document.getElementById('cart-items');
                container.innerHTML = '';
                
                this.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center text-sm p-3 bg-gray-800 rounded-lg shadow-inner border border-gray-700';
                    itemDiv.innerHTML = `
                        <div class="truncate flex-1 pr-2">
                            <h4 class="font-bold text-gray-100">${item.product.name}</h4>
                            <span class="text-xs text-gray-400 block">${item.product.formattedPrice} (unid)</span>
                        </div>
                        
                        <!-- Controles de Quantidade -->
                        <div class="flex items-center space-x-2">
                            <input type="number" min="1" value="${item.quantity}" data-id="${item.product.id}" 
                                    class="quantity-input w-12 text-center border border-gray-600 rounded-md p-1 bg-gray-900 text-white focus:input-focus text-sm"
                                    aria-label="Quantidade de ${item.product.name}">
                            
                            <span class="font-extrabold text-cyan-500 text-lg w-20 text-right">${formatCurrency(item.product.price * item.quantity)}</span>
                            
                            <button data-id="${item.product.id}" class="remove-item-btn text-red-500 hover:text-red-300 text-2xl leading-none transition" aria-label="Remover item">
                                &times;
                            </button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
                
                // Adiciona listeners para os botões de remoção
                container.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                        this.removeItem(productId);
                    });
                });

                // Adiciona listeners para os inputs de quantidade
                container.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                        this.changeQuantity(productId, e.currentTarget.value);
                    });
                });
            }
        }
        
        // Função utilitária de formatação de moeda (Real)
        const formatCurrency = (value) => `${REAL_SYMBOL} ${value.toFixed(2).replace('.', ',')}`;
        
        // Função utilitária para mensagens customizadas
        function displayMessage(text, type) {
            const container = document.getElementById('message-container');
            const color = {
                'success': 'bg-green-600',
                'alert': 'bg-red-600',
                'info': 'bg-blue-600'
            }[type] || 'bg-gray-600';

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg shadow-xl text-white font-semibold ${color} transition-opacity duration-300 transform translate-y-2 opacity-0 max-w-xs`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            
            // Animação de entrada
            setTimeout(() => {
                messageDiv.classList.remove('opacity-0', 'translate-y-2');
                messageDiv.classList.add('opacity-100');
            }, 10);

            // Animação de saída
            setTimeout(() => {
                messageDiv.classList.remove('opacity-100');
                messageDiv.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => messageDiv.remove(), 300);
            }, 5000);
        }

        // Inicialização global
        const productInstances = initialProducts.map(p => new Product(p.id, p.name, p.category, p.price, p.image, p.description));
        const productsGrid = document.getElementById('products-grid');
        const cart = new ShoppingCart();
        

        // ----------------------------------------------------
        // Lógica de Filtro e Busca
        // ----------------------------------------------------
        
        function setupFilters() {
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');

            // Preenche o seletor de categorias
            const categories = [...new Set(initialProducts.map(p => p.category))];
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });

            const applyFilters = () => {
                const searchText = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;

                const filteredProducts = productInstances.filter(product => {
                    const matchesName = product.name.toLowerCase().includes(searchText);
                    const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;
                    return matchesName && matchesCategory;
                });
                renderProducts(filteredProducts);
            };

            searchInput.addEventListener('input', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
        }

        // Renderiza cards de produto com base no array filtrado
        function renderProducts(productsToRender = productInstances) {
            productsGrid.innerHTML = '';
            if (productsToRender.length === 0) {
                productsGrid.innerHTML = '<p class="text-gray-400 text-lg col-span-full p-4 bg-gray-800 rounded-xl">Ops! Nenhum produto encontrado com os critérios de busca.</p>';
                return;
            }
            
            productsToRender.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card rounded-xl overflow-hidden';
                
                card.innerHTML = `
                    <!-- Adicionado fallback de imagem mais genérico -->
                    <img src="${product.image}" onerror="this.src='https://placehold.co/400x600/111827/06B6D4?text=${product.category.toUpperCase().replace(/\s/g, '+')}'" 
                            alt="${product.name}" class="w-full h-48 object-cover object-center border-b border-gray-700">
                    <div class="p-5">
                        <span class="text-xs font-semibold uppercase tracking-widest text-cyan-400">${product.category}</span>
                        <h3 class="text-xl font-bold text-gray-100 mt-1 mb-2 truncate" title="${product.name}">${product.name}</h3>
                        <p class="text-gray-400 text-sm h-10 overflow-hidden mb-4">${product.description}</p>
                        <div class="flex justify-between items-center mt-3 border-t border-gray-700 pt-3">
                            <span class="text-3xl font-extrabold text-green-400">${product.formattedPrice}</span>
                            <button data-id="${product.id}" class="add-to-cart-btn btn-primary text-black font-semibold px-4 py-2 rounded-lg text-sm transition hover:shadow-md">
                                Adicionar
                            </button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(card);
            });
            
            // Adiciona listeners de compra
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const productToAdd = productInstances.find(p => p.id === productId);
                    if (productToAdd) {
                        cart.addItem(productToAdd);
                        displayMessage(`"${productToAdd.name}" adicionado ao carrinho!`, 'info');
                    }
                });
            });
        }
        
        // Evento de Checkout
        document.getElementById('checkout-btn').addEventListener('click', () => {
            const subtotal = cart.getSubtotal();
            if (subtotal > 0) {
                const total = cart.getTotal();
                
                // Simulação visual de checkout
                document.getElementById('cart-items').innerHTML = `<p class="text-green-400 font-extrabold text-center p-4 bg-gray-800 rounded-lg">Compra Concluída com Sucesso! Total Pago: ${formatCurrency(total)}</p>`;
                
                // Simula a limpeza do carrinho e salvamento
                cart.items.clear();
                cart.saveCart(false); 
                
                displayMessage("Parabéns! Pedido finalizado. Obrigado por comprar conosco!", 'success');
                
                setTimeout(() => {
                    cart.updateUI(); // Renderiza o carrinho vazio
                }, 2000); 
            }
        });

        // Evento de Salvar Carrinho
        document.getElementById('save-cart-btn').addEventListener('click', () => {
            cart.saveCart(true);
        });

        // ----------------------------------------------------
        // Inicialização do Firebase e Autenticação
        // ----------------------------------------------------

        async function initFirebase() {
            try {
                // Tenta carregar as variáveis de ambiente
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configuração do Firebase não encontrada.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autenticação (tentativa de Custom Token ou Anônima)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Erro ao tentar signInWithCustomToken:", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                // O listener de estado de autenticação define o userId e carrega o carrinho
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true; // Autenticação concluída (token ou anônima)
                        
                        document.getElementById('user-id-display').textContent = `ID: ${userId} (${user.isAnonymous ? 'ANÔNIMO' : 'LOGADO'})`;
                        
                        // Atualiza a UI imediatamente para refletir o estado de login
                        cart.updateUI(); 

                        if (!user.isAnonymous) {
                            // Tenta carregar dados salvos apenas para usuários logados (não anônimos)
                            await cart.loadCart(); 
                        } else {
                            displayMessage("Sessão Anônima. O salvamento persistente de dados está desativado.", 'alert');
                        }
                    } else {
                        // Se houver falha crítica ou logout, reverte ao estado anônimo local
                        userId = crypto.randomUUID();
                        isAuthReady = false; 
                        document.getElementById('user-id-display').textContent = `ID: ERRO/DESCONECTADO`;
                        displayMessage("Erro de Conexão Firebase. O salvamento está desativado.", 'alert');
                        cart.updateUI();
                    }
                }); 

            } catch (e) {
                console.error("Erro fatal na inicialização do Firebase/Auth:", e);
                document.getElementById('user-id-display').textContent = `ID: ERRO DE CONEXÃO`;
                isAuthReady = false;
                cart.updateUI();
                displayMessage("A persistência de dados não pôde ser inicializada. Verifique a consola.", 'alert');
            }
        } 

        // Inicia a aplicação
        window.onload = () => {
            setupFilters(); 
            renderProducts();
            initFirebase(); 
            cart.updateUI(); // Chama updateUI uma vez antes da auth para configurar o estado inicial (R$ 0,00)
        };
    </script>
</body>
</html>